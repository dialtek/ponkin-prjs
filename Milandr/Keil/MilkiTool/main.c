 
/*------------------------------------------------------------*/ 
#include "MDR32Fx.h" // ??????????? ?????????? ?? 
#define F_CPU 8000000 // ???????? ???????? ??????? ?? 
#include "milkites_delay.h" // ??????????? ?????????? ???????? 
#include "milkites_SPI.h"
#include "milkites_display.h" // ??????????? ?????????? ??????? 

#define LCD_led_en MDR_PORTE->RXTX |= (1<<2) // ???. ?????????
#define LCD_led_dis MDR_PORTE->RXTX &= ~(1<<2) // ????. ?????????

#define DIR_1 MDR_PORTA->RXTX |= 1 					// motor dir
#define DIR_0 MDR_PORTA->RXTX &= ~ 1 
#define EN MDR_PORTA->RXTX |= (1<<1) 				// motor EN
#define DIS MDR_PORTA->RXTX &= ~ (1<<1) 
#define STEP_1 MDR_PORTA->RXTX |= (1<<3) 		// motor STEP
#define STEP_0 MDR_PORTA->RXTX &= ~ (1<<3) 

typedef struct motor_t
{
	uint32_t step;
	uint32_t dir;
	uint32_t en;

}motor;






//========================== ??????? ??? ==========================

void MCU_ADC_init() 
{ 
 MDR_RST_CLK->PER_CLOCK |= (1 << 17); // ???. ???????????? ??? 
 
 MDR_ADC->ADC1_CFG = (1 // ???. ??? 
 |(0 << 1) // ????? ???? «?????? ??????????????» 
 |(0 << 2) // ???????? ????????????? - CPU_CLK 
 |(1 << 3) // ?????????. ?????? ????? ?????????? ?????????????? 
 |(0 << 4) // ????? ?????? ?????????????? ????? ???. ????? 
 |(0 << 9) // ???????????? ??????? ???? 
 |(0 << 10) // ?????????????? ???????? ??????? ????. 
 |(0 << 11) // ???????? ???????? ?????????? – ?????.(AU??=VDD =3.3?) 
 |(3 << 12) // ??????????? ??????? ??????? ADC_clk = HCLK/8 = 10 ? 
 |(0 << 16) // ?????? ???? ??? ???????????? ????. 
 |(0 << 17) // ?????? ??????????? ? ???????? ?????????? ????. 
 |(0 << 18) // ????????? ??? ??????? ????. ? ???. ???????? ????.???? 
 |(0 << 19) // ????????? ??????? ??????????? ????. 
 |(0 << 20)); // ????????? ????????? ???????? ?????????? ?? 1.23 ? ????. 
} 


void MCU_ADC_set_ch(uint8_t channel) 
{ 
 // ???????? ?????? ?????? ? ??????? ? ?????? ?????? ?? ????????? 
 if (channel > 15) return; 
 MDR_ADC->ADC1_CFG |= channel << 4; // ???. ?????? ??? 
}
	
	void MCU_ADC_start_conv(void) 
{ 
 MDR_ADC->ADC1_CFG |= 1 << 1; // ??????? ?????? ?????????????? 
} 

uint32_t MCU_ADC_read(void) 
{ 
 uint32_t ADC_data = 0; // ????????? ??? ???????? ?????????? ??????. 
 
 MCU_ADC_start_conv(); // ??????? ?????? ?????????????? 
 // ?????? ???? - ???????? ????????? ?????????????? 
 //while(!(MDR_ADC->ADC1_STATUS) & (1<<2)) { } 
	delay_ms(1);
 ADC_data = MDR_ADC->ADC1_RESULT; // ?????? ?????????? ?????????????? 
 // ??????? ????? ?????????? ????? ?????? ?????????????? – ????????? 
 // ???????? ????????? ???????? 
 ADC_data = ADC_data & 0x0FFF; 
 return ADC_data; // ??????? ?????????? ?????????????? 
} 



//=================================================================

int main() 
{ 
uint32_t ch_4_counts = 0; // ?????????? ???????. ??????????????
float current = 0;
	
MDR_RST_CLK->PER_CLOCK = 0xffffffff; // ???. ???????????? ?????????
 
	
MDR_PORTE->OE = 0xff37; // ???? 7,6,3 PORTE - ?????, ??. - ??????
MDR_PORTE->FUNC = 0x0000; // ??????? - ????, ???????? ??????? 
MDR_PORTE->PWR = 0xff37; // ????. ??????? ????? 
MDR_PORTE->ANALOG = 0xffff; // ????? ?????? ????? - ???????? ????/?????
 
MDR_PORTD->OE &=~ (1 << 5); // ????????? PD4 ?? ????, ????? 4 ???
MDR_PORTD->ANALOG &=~ (1 << 5); // ??????? PD4 ? ?????????? ????? ??????
MDR_PORTD->PWR   = 0x800; 
MDR_PORTD->PULL   = (0x0 << 16) | (0x20); 	
	
MDR_PORTD->OE &=~ (1 << 5); // ????????? PD4 ?? ????, ????? 4 ???
MDR_PORTD->ANALOG &=~ (1 << 5); // ??????? PD4 ? ?????????? ????? ??????
MDR_PORTD->PWR   = 0x800; 
MDR_PORTD->PULL   = (0x0 << 16) | (0x20); 

MDR_PORTA->OE = 0xffff;
MDR_PORTA->FUNC = 0x0000;
MDR_PORTA->ANALOG = 0xffff;
MDR_PORTA->PWR   = 0xffff; 	
	
delay_init(); // ????????????? ??????? ???????? 
LCD_init(); // ????????????? ??????? hgh???gffg????
LCD_clear(); // ??????? ??????? 
//LCD_led_en; // ???. ????????? ??????? 
MCU_ADC_init(); // ????????????? ??? ?? 

 DIR_0;
 DIS; // EN - inversed

while (1) 
{ 
	STEP_1;
	delay_ms(5);
	STEP_0;
	delay_ms(5);
	
	
	
	/*
 MCU_ADC_set_ch(5); // ???. ?????? ??? 
 ch_4_counts = MCU_ADC_read(); // ?????? 4 ?????? ??? 
 LCD_set_cursor(0); // ????????? ??????? ???????
 LCD_print_text(" I counts = "); // ????? ?????? 
 LCD_print_num(ch_4_counts); // ????? ??????????? ??? ? 
	
 current = 	((float)ch_4_counts * 0.008)/(3.0 * 10.0) * 100.0;
 current += current*0.6;
 LCD_set_cursor(3); // ????????? ??????? ???????
 LCD_print_text(" I  = "); // ????? ?????? 
 LCD_print_num((uint32_t)current); // ????? ??????????? ??? ? 
	*/
	

 } // while 
} // main 
/*------------------------------------------------------------*/ 

/*

//Project name: PWM_for_Ports (Lab)//
//=========================================================================================================================//
#include "MDR32Fx.h"                  										  // Device header
#define   F_CPU 8000000																		// Clock frequency
#include "milkites_delay.h"																	// Library of delay
//#include "milkites_display.h"																// Library of display
#define LCD_led_en 		MDR_PORTE->RXTX |= (1 << 2) 				  // Illumination is ON
#define LCD_led_dis		MDR_PORTE->RXTX &= ~(1 << 2) 				  // Illumination is OFF
float brightness = 0;
int state_A = 0xAA;
//=========================================================================================================================//
// Initialization of use ports
void Ports_initialization()
{
	MDR_PORTE->OE			= 0b1111111100110111;										// Bytes 7, 6, 3 are input
	MDR_PORTE->FUNC 	= 0x0000;																// Function is Port, Basic function
	MDR_PORTE->PWR		= 0xFF37;																// The fastest front 
	MDR_PORTE->ANALOG	= 0xFFFF;																// Operation mode - I/O
	
	MDR_PORTA->OE 		= state_A;															// All pins are output
	MDR_PORTA->FUNC		= ((10 << 2)|(10 << 4));								// Function is port
	MDR_PORTA->ANALOG	= 0xFFFF;																// Operation mode - I/O
	MDR_PORTA->PWR		= state_A;															// The fastest front
}
//=========================================================================================================================//
// Initializing timer1
void Timer1_init(void)
{
	MDR_RST_CLK->TIM_CLOCK |= (1 << 24);   										// Clocking of the Timer1
	MDR_RST_CLK->TIM_CLOCK |= 0b000; 													// Frequency devider - 1:1
	MDR_TIMER1->CNTRL = 0x00000041;				 										// Mode is up and down
	MDR_TIMER1->PSG = 100;														  			// Frequency devider
	MDR_TIMER1->ARR = 511;								 							  		// CNT + 1 = 1000
	MDR_TIMER1->CNT = 0;									 										// Start value
	MDR_TIMER1->CH1_CNTRL1 = (2 << 2)|1;
	MDR_TIMER1->CCR2 = 0;
	MDR_TIMER1->CH1_CNTRL = 6 << 9;
	
	MDR_TIMER1->CH2_CNTRL1 = (2 << 2)|1;
	MDR_TIMER1->CH2_CNTRL = 6 << 9;
}
//=========================================================================================================================//
// Starting Timer1
void Timer1_start(void)
{
	MDR_TIMER1 -> CNTRL = 1; 																	// Timer1 start
}
//=========================================================================================================================//
void ADC_init( void  ){

    MDR_PORTD->OE &=~ 0x20;     //??????????? ???????? ?????? - ???? ( PD: 5  )
    MDR_PORTD->ANALOG &=~ 0x20;     //????? ?????? ??????????? - ?????????? ( PD: 5  )
    //????????:
    MDR_PORTD->PULL   = (0x0 << 16) | (0x20); 
    MDR_PORTD->PD   = (0x0 << 16) | (0x0);     //????? ?????? ???????
    //???????? :
                          ??????? ????? ( PD: 5  )
    MDR_PORTD->PWR   = 0x800; 
	
}//void ADC_init



int main()
{
	// PD5
 	
	
	MDR_RST_CLK->PER_CLOCK = 0xFFFFFFFF;											// Clocking of all periphery
	Ports_initialization();																		// Initializing ports settings
	//ADC_init();
	delay_init();																					  	// Initializing delay library
	//LCD_init();																								// Initializing display library
	//LCD_clear();																							// Cleaning display
	//LCD_led_en;																								// Illumination is enable
	//Timer1_init();																						// Initializing Timer 1
	//Timer1_start();
	
	while(1)
	{
		LCD_led_en;	
		delay_ms(3000);
		LCD_led_dis;	
		delay_ms(3000);
		

	}
}

*/
//============================================END_OF_CODE=======================================================================//