#include "MDR32Fx.h" 
#include "milkites_spi.h"

// SPI
void MDR32_SSP1_init (void)
	{
	  
	 
  // ????????? ?????? SSP1 ??? ?????? ? MT-12864B: ????? ????????, 16-?????? ?????
	MDR_RST_CLK->SSP_CLOCK = (1 << 24) |    // ?????????? ???????? ??????? ?? SSP 1
                                 8;       // ???????? ???????? ??????? SSP1, SSP1_CLK = HCLK (8 ???)
    
	MDR_SSP1->CR0 = (0 << 8) | 			  // ?????? ???????? SCR ??????? F_SSP1 = SSP1_CLK / (CPSDVR*(1  + SCR)) 
									(1 << 7) |			  // ????  ???????  SSPCLKOUT, ????????? ???? ?????
									(1 << 6) |			  // ??????????  ???????  SSPCLKOUT, ????????????? ?? ????????? ??????
									(0 << 4) |			  // ?????? ??????????????? ????? -  ???????? SPI ????? Motorola
												7;				  // ?????? ????? ?????? - 0111 – 16 ???
   
	MDR_SSP1->CPSR = 2; 				  // ???????????  ???????  ????????  ?????? CPSDVR
															  // ????? ???????, ??? CPSDVR = 2, SCR = 0, F_SSP1 = 8 ???
																// ??????? SSP1_CLK ?????????? ?????? 4 ???
	
	MDR_SSP1->CR1 = (0 << 2) |			  // ????? ???????? ??? ???????? ?????? ??????: 0 – ??????? ?????? 
					(1 << 1); 		    			  // ?????????? ?????? ?????????????????
	
  // ???? SPI1_TxD ? SPI1_CLK ????????? ?? ????? ? GPIO_init()
	// ????? ??????? ?????????????? ????? ????? - ???????????? ?????? SSP1
  // ???? PF0 - PF3 ???????????? ???? ???????!
	}


void SPI1_Wr_Data (uint16_t data)
{
	
		
	  
	  // ??????? ???????? ?????? ?? ???? SSP1
	  // ??????? DR - 16 ???
	  MDR_SSP1->DR = data;
	  //------- ??? ?????? ? ???????? MT 12864B --------------------------------
		
	  LCD_CS_OFF;				  // ????????????? ???????? SSP1_FSS, 
	  							      // ??????? ??? ????? ?????? ???? ????????	
							  	      // ??????????????? ?? ????????????? ??? ????????
	  //------- ??? ?????? ? ???????? MT 12864B --------------------------------
}


uint16_t SPI1_Rd_Data (void)
{
	  
	  // ??????? ????????? ?????? ???? SSP1
	  // ??????? DR - 16 ???
	  
	  uint16_t rx_buf = 0;
	  MDR_SSP1->DR = 0;	         // ???????????? ???????? ????????
	  while(MDR_SSP1->SR & 1<<4) { } // ???? ?????????? ??????
	  
	  rx_buf = MDR_SSP1->DR;
	  
	  return rx_buf;

}

